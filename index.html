<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Patrimonio</title>
    <!-- Adiciona o script do Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adiciona o script do Chart.js para criar os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full" id="main-container">
        <!-- Exibição do ID do Usuário -->
        <div class="text-xs text-right text-gray-400 mb-4">
            ID do Usuário: <span id="userIdDisplay">Carregando...</span>
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Calculadora de Patrimonio</h1>
        <p class="text-center text-gray-600 mb-8">
            Calcule seu patrimonio total com base no seu gasto mensal e na porcentagem que ele representa.
        </p>
        
        <!-- Seção de Explicação da Regra dos 4% -->
        <div class="mb-12 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">A Regra dos 4%: Por Que Ela é Essencial?</h2>
            <p class="text-gray-700 leading-relaxed mb-4">
                A <strong>Regra dos 4%</strong> é um conceito fundamental no mundo da independência financeira. Ela sugere que, para um patrimonio que está sendo investido, a retirada anual de até 4% desse valor pode ser feita de forma sustentável, sem esgotar o capital ao longo do tempo.
            </p>
            <p class="text-gray-700 leading-relaxed">
                A regra foi popularizada pelo <a href="#" class="text-indigo-600 hover:underline">Trinity Study</a>, um estudo que analisou o desempenho de portfólios de investimento ao longo de décadas. O estudo concluiu que, com uma alocação de ativos diversificada, uma taxa de retirada de 4% ao ano tinha uma alta probabilidade de sucesso por 30 anos ou mais.
            </p>
        </div>

        <div class="space-y-6">
            <div>
                <label for="valorDesejado" class="block text-gray-700 font-semibold mb-2">Valor que desejo Ganhar mensalmente no futuro (R$)</label>
                <input type="number" id="valorDesejado" value="8000" placeholder="Ex: 8000" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
            <div>
                <label for="percentual" class="block text-gray-700 font-semibold mb-2">Porcentagem do Patrimonio Total (%)</label>
                <input type="number" id="percentual" value="2.4" placeholder="Ex: 2.4" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
        </div>

        <div id="resultadoPatrimonio" class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200 hidden">
            <h2 class="text-xl font-bold text-blue-800">Seu Patrimonio Total é:</h2>
            <p id="valorPatrimonio" class="text-2xl font-extrabold text-blue-900 mt-2"></p>
        </div>

        <div id="mensagemErroPatrimonio" class="mt-8 p-4 bg-red-100 text-red-700 font-medium rounded-lg hidden">
            Por favor, insira valores válidos para calcular o patrimonio.
        </div>
        
        <hr class="my-8 border-t-2 border-gray-200">

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Planejamento da Carteira de Investimento</h2>
        <p class="text-center text-gray-600 mb-8">
            Distribua seu patrimonio entre as classes de ativos para alcançar seu objetivo.
        </p>

        <div class="space-y-6">
            <div class="flex items-center space-x-4">
                <label for="fiiPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">FII (%)</label>
                <input type="number" id="fiiPercentual" value="20" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="fiiValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="acoesPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Ações (%)</label>
                <input type="number" id="acoesPercentual" value="60" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="acoesValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="rendaFixaPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Renda Fixa (%)</label>
                <input type="number" id="rendaFixaPercentual" value="5" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="rendaFixaValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="internacionalPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Internacional (%)</label>
                <input type="number" id="internacionalPercentual" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right" readonly>
                <span id="internacionalValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
        </div>

        <div id="mensagemErroCarteira" class="mt-8 p-4 bg-red-100 text-red-700 font-medium rounded-lg hidden">
            A soma das porcentagens deve ser exatamente 100%. Por favor, ajuste os valores.
        </div>
        
        <!-- Canvas para o gráfico de pizza -->
        <div id="pieChartContainer" class="mt-8 hidden">
            <h2 class="text-xl font-bold text-center text-gray-800 mb-4">Alocação da Carteira</h2>
            <canvas id="portfolioPieChart"></canvas>
        </div>

        <hr class="my-8 border-t-2 border-gray-200">

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Dividendos Projetados</h2>
        <p class="text-center text-gray-600 mb-8">
            Calcule os dividendos anuais e mensais com base no retorno projetado de cada classe de ativo.
        </p>

        <div class="space-y-6">
            <div class="flex items-center space-x-4">
                <label for="fiiDividendoPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">FII (%)</label>
                <input type="number" id="fiiDividendoPercentual" value="12" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="fiiDividendoValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="acoesDividendoPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Ações (%)</label>
                <input type="number" id="acoesDividendoPercentual" value="9" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="acoesDividendoValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="rendaFixaDividendoPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Renda Fixa (%)</label>
                <input type="number" id="rendaFixaDividendoPercentual" value="13" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="rendaFixaDividendoValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
            <div class="flex items-center space-x-4">
                <label for="internacionalDividendoPercentual" class="block text-gray-700 font-semibold mb-2 w-1/3">Internacional (%)</label>
                <input type="number" id="internacionalDividendoPercentual" value="14" class="w-2/3 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-right">
                <span id="internacionalDividendoValor" class="text-base font-bold text-gray-800 w-1/3 text-right"></span>
            </div>
        </div>

        <div id="resultadoDividendos" class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200 hidden">
            <h2 class="text-xl font-bold text-blue-800">Dividendos Projetados:</h2>
            <ul class="list-disc list-inside mt-4 text-gray-700 space-y-2">
                <li><span class="font-bold">Total Anual:</span> <span id="totalDividendoAnual" class="font-extrabold text-blue-900"></span></li>
                <li><span class="font-bold">Total Mensal:</span> <span id="totalDividendoMensal" class="font-extrabold text-blue-900"></span></li>
            </ul>
        </div>

        <hr class="my-8 border-t-2 border-gray-200">

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Cálculo de Investimento Mensal</h2>
        <p class="text-center text-gray-600 mb-8">
            Descubra quanto precisa investir mensalmente para alcançar o patrimonio desejado.
        </p>
        
        <div class="space-y-6">
            <div>
                <label for="aporteInicial" class="block text-gray-700 font-semibold mb-2">Valor de Aporte Inicial (R$)</label>
                <input type="number" id="aporteInicial" value="1900000" placeholder="Ex: 1900000" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
            <div>
                <label for="taxaRetorno" class="block text-gray-700 font-semibold mb-2">Taxa de Retorno Anual (%)</label>
                <input type="number" id="taxaRetorno" placeholder="Ex: 6" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
            
            <div>
                <label for="anos" class="block text-gray-700 font-semibold mb-2">Tempo em Anos</label>
                <input type="number" id="anos" value="6" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
        </div>

        <div id="resultadoInvestimento" class="mt-8 p-6 bg-green-50 rounded-lg border border-green-200 hidden">
            <h2 class="text-xl font-bold text-green-800">Você precisa investir:</h2>
            <p id="valorInvestimento" class="text-2xl font-extrabold text-green-900 mt-2"></p>
        </div>
        
        <div id="mensagemErroInvestimento" class="mt-8 p-4 bg-red-100 text-red-700 font-medium rounded-lg hidden">
            Por favor, insira valores válidos. A taxa de retorno e o tempo devem ser maiores que zero.
        </div>

        <!-- Canvas para o gráfico de investimento -->
        <div id="chartContainer" class="mt-8 h-[400px] hidden">
            <h2 class="text-xl font-bold text-center text-gray-800 mb-4">Crescimento do Patrimonio</h2>
            <canvas id="investmentChart"></canvas>
        </div>
        
        <hr class="my-8 border-t-2 border-gray-200">

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Analise de Inflação e Crescimento Real</h2>
        <p class="text-center text-gray-600 mb-8">
            Verifique se seu patrimonio está crescendo acima da inflação.
        </p>

        <div class="space-y-6">
            <div>
                <label for="inflacaoAnual" class="block text-gray-700 font-semibold mb-2">Inflação Anual (%)</label>
                <input type="number" id="inflacaoAnual" value="6" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
        </div>

        <div id="resultadoInflacao" class="mt-8 p-6 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
            <h2 class="text-xl font-bold text-yellow-800">Analise de Crescimento:</h2>
            <ul class="list-disc list-inside mt-4 text-gray-700 space-y-2">
                <li><span class="font-bold">Retorno Real da Carteira:</span> <span id="retornoReal" class="font-extrabold text-yellow-900"></span><p class="text-sm mt-1 text-gray-600" id="retornoRealExplicacao"></p></li>
                <li><span class="font-bold">Aporte Necessário para FIIs (proximo ano):</span> <span id="aporteFiiInflacao" class="font-extrabold text-yellow-900"></span><p class="text-sm mt-1 text-gray-600" id="aporteFiiExplicacao"></p></li>
            </ul>
        </div>
        
        <hr class="my-8 border-t-2 border-gray-200">

        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Projeção do Patrimonio para o Proximo Ano após atingir a Meta</h2>
        <p class="text-center text-gray-600 mb-8">
            Calcule o valor do seu patrimonio para o proximo ano, considerando os rendimentos.
        </p>
        
        <div id="resultadoProximoAno" class="mt-8 p-6 bg-purple-50 rounded-lg border border-purple-200 hidden">
            <h2 class="text-xl font-bold text-purple-800">Crescimento Projetado:</h2>
            <ul class="list-disc list-inside mt-4 text-gray-700 space-y-2">
                <li><span class="font-bold">Patrimonio Total para o Proximo Ano:</span> <span id="patrimonioProximoAno" class="font-extrabold text-purple-900"></span></li>
                <li><span class="font-bold">Crescimento Anual em Valor:</span> <span id="crescimentoValor" class="font-extrabold text-purple-900"></span></li>
                <li><span class="font-bold">Crescimento Anual em %:</span> <span id="crescimentoPercentual" class="font-extrabold text-purple-900"></span></li>
            </ul>
            <p class="mt-4 text-sm text-gray-600">Este cálculo reflete o valor total do seu patrimonio para o próximo ano, somando o patrimonio inicial com o total de dividendos, subtraindo o valor de aporte em FIIs sugerido para a correção da inflação. Esta abordagem permite visualizar o crescimento considerando a realocação de capital e a manutenção do poder de compra.</p>
        </div>
        
        <hr class="my-8 border-t-2 border-gray-200">

        <!-- Seção de Relatório -->
        <div id="relatorioCompleto" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Relatório de Analise</h2>
            <div class="space-y-4">
                <p><span class="font-semibold text-gray-700">Objetivo de Renda Mensal:</span> <span id="reportValorDesejado" class="font-bold text-gray-900"></span></p>
                <p><span class="font-semibold text-gray-700">Patrimonio Total Necessário:</span> <span id="reportPatrimonioTotal" class="font-bold text-gray-900"></span></p>
                <h3 class="font-semibold text-gray-700 text-lg mt-4">Alocação de Patrimonio:</h3>
                <ul class="list-disc list-inside text-gray-700">
                    <li>FII: <span id="reportFiiValor" class="font-bold text-gray-900"></span></li>
                    <li>Ações: <span id="reportAcoesValor" class="font-bold text-gray-900"></span></li>
                    <li>Renda Fixa: <span id="reportRendaFixaValor" class="font-bold text-gray-900"></span></li>
                    <li>Internacional: <span id="reportInternacionalValor" class="font-bold text-gray-900"></span></li>
                </ul>
                <h3 class="font-semibold text-gray-700 text-lg mt-4">Dividendos Projetados Anuais:</h3>
                <ul class="list-disc list-inside text-gray-700">
                    <li>Total Anual: <span id="reportTotalDividendoAnual" class="font-bold text-gray-900"></span></li>
                    <li>Total Mensal: <span id="reportTotalDividendoMensal" class="font-bold text-gray-900"></span></li>
                </ul>
                <h3 class="font-semibold text-gray-700 text-lg mt-4">Analise de Crescimento Real:</h3>
                <ul class="list-disc list-inside text-gray-700">
                    <li>Retorno Real: <span id="reportRetornoReal" class="font-bold text-gray-900"></span></li>
                    <li>Aporte em FIIs para Inflação: <span id="reportAporteFiiInflacao" class="font-bold text-gray-900"></span></li>
                </ul>
                <p class="mt-4"><span class="font-semibold text-gray-700">Para atingir o objetivo, você precisa investir mensalmente:</span> <span id="reportInvestimentoMensal" class="font-bold text-green-700"></span></p>
                
                <!-- Nova seção de análise de viabilidade -->
                <h3 class="font-semibold text-gray-700 text-lg mt-4">Analise de Viabilidade: FIIs</h3>
                <p id="analiseViabilidadeFII" class="text-gray-700"></p>
            </div>
        </div>
        
        <div class="mt-8 flex justify-center space-x-4">
            <button onclick="saveData()" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition-colors">
                Salvar Dados
            </button>
        </div>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Obtém a configuração do Firebase do ambiente se disponível.
        // Se não, é um fallback para um ambiente externo (como o GitHub Pages).
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Se você estiver executando este código em um ambiente que não seja a plataforma
            // de desenvolvimento, cole sua própria configuração do Firebase aqui:
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_AUTH_DOMAIN",
            // projectId: "YOUR_PROJECT_ID",
            // ... outras chaves
        };
        
        // Inicializa o Firebase somente se a configuração for válida.
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;
        
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Tenta obter o token de autenticação personalizado da variável de ambiente
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // Listener para o estado de autenticação
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    console.log("Usuário autenticado:", userId);
                    loadData();
                } else {
                    console.log("Nenhum usuário logado. Tentando login...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Login com token personalizado bem-sucedido.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Login anônimo bem-sucedido.");
                        }
                    } catch (error) {
                        console.error("Erro de Autenticação do Firebase:", error);
                        document.getElementById('userIdDisplay').textContent = "Falha na autenticação";
                    }
                }
            });
        } else {
            console.error("Configuração do Firebase ausente ou inválida. O aplicativo não funcionará corretamente.");
            document.getElementById('userIdDisplay').textContent = "Configuração ausente";
        }

        let myChart = null;
        let myPieChart = null;

        // Função para salvar dados no Firestore
        window.saveData = async () => {
            if (!userId) {
                console.error("Usuário não autenticado. Não é possível salvar os dados.");
                return;
            }

            const data = {
                valorDesejado: document.getElementById('valorDesejado').value,
                percentual: document.getElementById('percentual').value,
                fiiPercentual: document.getElementById('fiiPercentual').value,
                acoesPercentual: document.getElementById('acoesPercentual').value,
                rendaFixaPercentual: document.getElementById('rendaFixaPercentual').value,
                internacionalPercentual: document.getElementById('internacionalPercentual').value,
                fiiDividendoPercentual: document.getElementById('fiiDividendoPercentual').value,
                acoesDividendoPercentual: document.getElementById('acoesDividendoPercentual').value,
                rendaFixaDividendoPercentual: document.getElementById('rendaFixaDividendoPercentual').value,
                internacionalDividendoPercentual: document.getElementById('internacionalDividendoPercentual').value,
                taxaRetorno: document.getElementById('taxaRetorno').value,
                anos: document.getElementById('anos').value,
                inflacaoAnual: document.getElementById('inflacaoAnual').value,
                aporteInicial: document.getElementById('aporteInicial').value,
            };

            const dataPath = `users/${userId}/data`;
            const docRef = doc(db, dataPath, "user_data");

            try {
                await setDoc(docRef, data);
                showMessage("Dados salvos com sucesso!", 'bg-green-100 text-green-700');
            } catch (e) {
                console.error("Erro ao salvar os dados: ", e);
                showMessage("Erro ao salvar os dados.", 'bg-red-100 text-red-700');
            }
        };

        // Função para carregar dados do Firestore
        const loadData = () => {
            if (!userId) {
                console.log("Aguardando autenticação para carregar os dados.");
                return;
            }

            const dataPath = `users/${userId}/data`;
            const docRef = doc(db, dataPath, "user_data");

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('valorDesejado').value = data.valorDesejado;
                    document.getElementById('percentual').value = data.percentual;
                    document.getElementById('fiiPercentual').value = data.fiiPercentual;
                    document.getElementById('acoesPercentual').value = data.acoesPercentual;
                    document.getElementById('rendaFixaPercentual').value = data.rendaFixaPercentual;
                    document.getElementById('internacionalPercentual').value = data.internacionalPercentual;
                    document.getElementById('fiiDividendoPercentual').value = data.fiiDividendoPercentual;
                    document.getElementById('acoesDividendoPercentual').value = data.acoesDividendoPercentual;
                    document.getElementById('rendaFixaDividendoPercentual').value = data.rendaFixaDividendoPercentual;
                    document.getElementById('internacionalDividendoPercentual').value = data.internacionalDividendoPercentual;
                    document.getElementById('taxaRetorno').value = data.taxaRetorno;
                    document.getElementById('anos').value = data.anos;
                    document.getElementById('inflacaoAnual').value = data.inflacaoAnual;
                    document.getElementById('aporteInicial').value = data.aporteInicial;

                    recalcularTudo();
                } else {
                    console.log("Nenhum dado encontrado para este usuário.");
                }
            }, (error) => {
                console.error("Erro ao ler dados: ", error);
            });
        };

        // Função para exibir mensagens
        const showMessage = (message, className) => {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-4 rounded-lg text-center ${className}`;
            const container = document.querySelector('.bg-white');
            container.insertBefore(messageBox, container.lastChild);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        };
        
        // Objeto para armazenar as funções de cálculo
        const Calculadora = {
            recalcularTudo: () => {
                Calculadora.calcularPatrimonio();
                Calculadora.calcularCarteira();
                Calculadora.calcularDividendos();
                Calculadora.calcularInvestimentoMensal();
                Calculadora.analisarInflacao();
                Calculadora.calcularProximoAno();
            },

            calcularPatrimonio: () => {
                const valorDesejado = parseFloat(document.getElementById('valorDesejado').value);
                const percentual = parseFloat(document.getElementById('percentual').value);
                const resultadoDiv = document.getElementById('resultadoPatrimonio');
                const mensagemErroDiv = document.getElementById('mensagemErroPatrimonio');
                
                resultadoDiv.classList.add('hidden');
                mensagemErroDiv.classList.add('hidden');
                
                if (isNaN(valorDesejado) || isNaN(percentual) || percentual <= 0) {
                    mensagemErroDiv.classList.remove('hidden');
                    return;
                }
                
                const patrimonioTotal = (valorDesejado * 12) / (percentual / 100);
                sessionStorage.setItem('patrimonioTotal', patrimonioTotal);
                sessionStorage.setItem('valorDesejado', valorDesejado);
                
                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                document.getElementById('valorPatrimonio').textContent = formatter.format(patrimonioTotal);
                resultadoDiv.classList.remove('hidden');
                document.getElementById('reportValorDesejado').textContent = formatter.format(valorDesejado);
                document.getElementById('reportPatrimonioTotal').textContent = formatter.format(patrimonioTotal);
            },
            
            calcularInvestimentoMensal: () => {
                const aporteInicial = parseFloat(document.getElementById('aporteInicial').value);
                const taxaRetorno = parseFloat(document.getElementById('taxaRetorno').value);
                const anos = parseFloat(document.getElementById('anos').value);
                const resultadoDiv = document.getElementById('resultadoInvestimento');
                const valorInvestimentoSpan = document.getElementById('valorInvestimento');
                const mensagemErroDiv = document.getElementById('mensagemErroInvestimento');
                const chartContainer = document.getElementById('chartContainer');
                const relatorioCompletoDiv = document.getElementById('relatorioCompleto');
                const patrimonioTotal = parseFloat(sessionStorage.getItem('patrimonioTotal'));
                const totalDividendoAnualPercentual = parseFloat(sessionStorage.getItem('totalDividendoAnualPercentual'));

                resultadoDiv.classList.add('hidden');
                mensagemErroDiv.classList.add('hidden');
                chartContainer.classList.add('hidden');

                if (isNaN(patrimonioTotal) || isNaN(aporteInicial) || isNaN(taxaRetorno) || isNaN(anos) || taxaRetorno <= 0 || anos <= 0) {
                    mensagemErroDiv.classList.remove('hidden');
                    return;
                }
                
                let investimentoMensal = 0;
                if (aporteInicial < patrimonioTotal) {
                    const taxaMensal = (taxaRetorno / 100) / 12;
                    const periodos = anos * 12;
                    investimentoMensal = (patrimonioTotal - aporteInicial * Math.pow(1 + taxaMensal, periodos)) / ((Math.pow(1 + taxaMensal, periodos) - 1) / taxaMensal);
                }
                
                sessionStorage.setItem('investimentoMensal', investimentoMensal);
                
                const labels = [];
                const patrimonioData = [];
                const dividendosData = [];
                let patrimonioAtual = aporteInicial;
                const taxaDividendo = isNaN(totalDividendoAnualPercentual) ? 0 : totalDividendoAnualPercentual / 100;

                for (let i = 1; i <= anos; i++) {
                    labels.push(`Ano ${i}`);
                    patrimonioAtual = (patrimonioAtual + investimentoMensal * 12) * (1 + taxaRetorno / 100);
                    patrimonioData.push(patrimonioAtual);
                    const dividendosAnuais = patrimonioAtual * taxaDividendo;
                    dividendosData.push(dividendosAnuais);
                }

                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                valorInvestimentoSpan.textContent = formatter.format(investimentoMensal);
                resultadoDiv.classList.remove('hidden');
                document.getElementById('reportInvestimentoMensal').textContent = formatter.format(investimentoMensal);

                Calculadora.renderCombinedChart(labels, patrimonioData, dividendosData);
                relatorioCompletoDiv.classList.remove('hidden');
            },

            renderCombinedChart: (labels, patrimonioData, dividendosData) => {
                if (myChart) {
                    myChart.destroy();
                }

                const ctx = document.getElementById('investmentChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Patrimônio Total',
                                data: patrimonioData,
                                backgroundColor: '#2563eb',
                                yAxisID: 'y-patrimonio'
                            },
                            {
                                label: 'Dividendos Anuais',
                                data: dividendosData,
                                type: 'line',
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y-dividendos'
                            },
                            {
                                label: 'Média de Dividendo Mensal',
                                data: dividendosData.map(d => d / 12),
                                type: 'bar',
                                backgroundColor: '#f59e0b',
                                yAxisID: 'y-dividendos'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            'y-patrimonio': {
                                position: 'left',
                                beginAtZero: true,
                                title: { display: true, text: 'Patrimônio (R$)', color: '#2563eb' },
                                ticks: { callback: (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0 }).format(value) }
                            },
                            'y-dividendos': {
                                position: 'right',
                                beginAtZero: true,
                                title: { display: true, text: 'Dividendos (R$)', color: '#10b981' },
                                ticks: { callback: (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0 }).format(value) }
                            }
                        }
                    }
                });
                document.getElementById('chartContainer').classList.remove('hidden');
            },

            renderPieChart: (labels, data) => {
                if (myPieChart) {
                    myPieChart.destroy();
                }
                const ctx = document.getElementById('portfolioPieChart').getContext('2d');
                const colors = ['#22c55e', '#ef4444', '#f59e0b', '#3b82f6'];
                myPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        return `${label}: ${value}%`;
                                    }
                                }
                            }
                        }
                    }
                });
                document.getElementById('pieChartContainer').classList.remove('hidden');
            },

            calcularCarteira: () => {
                const patrimonioTotal = parseFloat(sessionStorage.getItem('patrimonioTotal'));
                if (isNaN(patrimonioTotal)) return;

                const fiiPercentual = parseFloat(document.getElementById('fiiPercentual').value);
                const acoesPercentual = parseFloat(document.getElementById('acoesPercentual').value);
                const rendaFixaPercentual = parseFloat(document.getElementById('rendaFixaPercentual').value);
                const mensagemErroDiv = document.getElementById('mensagemErroCarteira');

                mensagemErroDiv.classList.add('hidden');
                
                if (isNaN(fiiPercentual) || isNaN(acoesPercentual) || isNaN(rendaFixaPercentual)) {
                    mensagemErroDiv.textContent = "Por favor, insira valores válidos.";
                    mensagemErroDiv.classList.remove('hidden');
                    return;
                }
                const internacionalPercentual = 100 - (fiiPercentual + acoesPercentual + rendaFixaPercentual);
                document.getElementById('internacionalPercentual').value = internacionalPercentual.toFixed(2);

                const valorFii = (patrimonioTotal * fiiPercentual) / 100;
                const valorAcoes = (patrimonioTotal * acoesPercentual) / 100;
                const valorRendaFixa = (patrimonioTotal * rendaFixaPercentual) / 100;
                const valorInternacional = (patrimonioTotal * internacionalPercentual) / 100;

                sessionStorage.setItem('valorFii', valorFii);
                sessionStorage.setItem('fiiPercentual', fiiPercentual);

                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                document.getElementById('fiiValor').textContent = `(${formatter.format(valorFii)})`;
                document.getElementById('acoesValor').textContent = `(${formatter.format(valorAcoes)})`;
                document.getElementById('rendaFixaValor').textContent = `(${formatter.format(valorRendaFixa)})`;
                document.getElementById('internacionalValor').textContent = `(${formatter.format(valorInternacional)})`;

                document.getElementById('reportFiiValor').textContent = `${formatter.format(valorFii)} (${fiiPercentual}%)`;
                document.getElementById('reportAcoesValor').textContent = `${formatter.format(valorAcoes)} (${acoesPercentual}%)`;
                document.getElementById('reportRendaFixaValor').textContent = `${formatter.format(valorRendaFixa)} (${rendaFixaPercentual}%)`;
                document.getElementById('reportInternacionalValor').textContent = `${formatter.format(valorInternacional)} (${internacionalPercentual}%)`;

                const labels = ['FII', 'Ações', 'Renda Fixa', 'Internacional'];
                const data = [fiiPercentual, acoesPercentual, rendaFixaPercentual, internacionalPercentual];
                Calculadora.renderPieChart(labels, data);
            },

            calcularDividendos: () => {
                const patrimonioTotal = parseFloat(sessionStorage.getItem('patrimonioTotal'));
                if (isNaN(patrimonioTotal)) return;
                
                const fiiPercentual = parseFloat(document.getElementById('fiiPercentual').value);
                const acoesPercentual = parseFloat(document.getElementById('acoesPercentual').value);
                const rendaFixaPercentual = parseFloat(document.getElementById('rendaFixaPercentual').value);
                const internacionalPercentual = parseFloat(document.getElementById('internacionalPercentual').value);

                const valorFii = (patrimonioTotal * fiiPercentual) / 100;
                const valorAcoes = (patrimonioTotal * acoesPercentual) / 100;
                const valorRendaFixa = (patrimonioTotal * rendaFixaPercentual) / 100;
                const valorInternacional = (patrimonioTotal * internacionalPercentual) / 100;
                
                const fiiDividendoPercentual = parseFloat(document.getElementById('fiiDividendoPercentual').value);
                const acoesDividendoPercentual = parseFloat(document.getElementById('acoesDividendoPercentual').value);
                const rendaFixaDividendoPercentual = parseFloat(document.getElementById('rendaFixaDividendoPercentual').value);
                const internacionalDividendoPercentual = parseFloat(document.getElementById('internacionalDividendoPercentual').value);
                const resultadoDividendosDiv = document.getElementById('resultadoDividendos');

                if (isNaN(patrimonioTotal) || isNaN(fiiDividendoPercentual) || isNaN(acoesDividendoPercentual) || isNaN(rendaFixaDividendoPercentual) || isNaN(internacionalDividendoPercentual)) return;

                const fiiDividendoAnual = (valorFii * fiiDividendoPercentual) / 100;
                const acoesDividendoAnual = (valorAcoes * acoesDividendoPercentual) / 100;
                const rendaFixaDividendoAnual = (valorRendaFixa * rendaFixaDividendoPercentual) / 100;
                const internacionalDividendoAnual = (valorInternacional * internacionalDividendoPercentual) / 100;

                const totalDividendoAnual = fiiDividendoAnual + acoesDividendoAnual + rendaFixaDividendoAnual + internacionalDividendoAnual;
                const totalDividendoMensal = totalDividendoAnual / 12;
                const totalDividendoAnualPercentual = (totalDividendoAnual / patrimonioTotal) * 100;
                const totalDividendoMensalPercentual = totalDividendoAnualPercentual / 12;

                sessionStorage.setItem('fiiDividendoAnual', fiiDividendoAnual);
                sessionStorage.setItem('totalDividendoAnual', totalDividendoAnual);
                sessionStorage.setItem('totalDividendoAnualPercentual', totalDividendoAnualPercentual);

                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                const fiiTotalPercent = totalDividendoAnual > 0 ? (fiiDividendoAnual / totalDividendoAnual) * 100 : 0;
                const acoesTotalPercent = totalDividendoAnual > 0 ? (acoesDividendoAnual / totalDividendoAnual) * 100 : 0;
                const rendaFixaTotalPercent = totalDividendoAnual > 0 ? (rendaFixaDividendoAnual / totalDividendoAnual) * 100 : 0;
                const internacionalTotalPercent = totalDividendoAnual > 0 ? (internacionalDividendoAnual / totalDividendoAnual) * 100 : 0;

                document.getElementById('fiiDividendoValor').textContent = `(${formatter.format(fiiDividendoAnual)} - ${fiiTotalPercent.toFixed(2)}%)`;
                document.getElementById('acoesDividendoValor').textContent = `(${formatter.format(acoesDividendoAnual)} - ${acoesTotalPercent.toFixed(2)}%)`;
                document.getElementById('rendaFixaDividendoValor').textContent = `(${formatter.format(rendaFixaDividendoAnual)} - ${rendaFixaTotalPercent.toFixed(2)}%)`;
                document.getElementById('internacionalDividendoValor').textContent = `(${formatter.format(internacionalDividendoAnual)} - ${internacionalTotalPercent.toFixed(2)}%)`;
                document.getElementById('totalDividendoAnual').textContent = `${formatter.format(totalDividendoAnual)} (${totalDividendoAnualPercentual.toFixed(2)}% ao ano)`;
                document.getElementById('totalDividendoMensal').textContent = `${formatter.format(totalDividendoMensal)} (${totalDividendoMensalPercentual.toFixed(2)}% ao mês)`;
                resultadoDividendosDiv.classList.remove('hidden');

                document.getElementById('taxaRetorno').value = totalDividendoAnualPercentual.toFixed(2);
                document.getElementById('reportTotalDividendoAnual').textContent = `${formatter.format(totalDividendoAnual)} (${totalDividendoAnualPercentual.toFixed(2)}% ao ano)`;
                document.getElementById('reportTotalDividendoMensal').textContent = `${formatter.format(totalDividendoMensal)} (${totalDividendoMensalPercentual.toFixed(2)}% ao mês)`;
                
                const valorDesejado = parseFloat(sessionStorage.getItem('valorDesejado'));
                const fiiDividendoMensal = fiiDividendoAnual / 12;
                let analiseTexto = '';
                if (fiiDividendoMensal >= valorDesejado) {
                    analiseTexto = `<span class="text-green-700 font-bold">Viável.</span> Os dividendos mensais dos FIIs (${formatter.format(fiiDividendoMensal)}) são suficientes para cobrir seu objetivo de renda mensal (${formatter.format(valorDesejado)}).`;
                } else {
                    analiseTexto = `<span class="text-red-700 font-bold">Não viável.</span> Os dividendos mensais dos FIIs (${formatter.format(fiiDividendoMensal)}) não são suficientes para cobrir seu objetivo de renda mensal (${formatter.format(valorDesejado)}). Você precisará de dividendos de outras classes de ativos para atingir o objetivo.`;
                }
                document.getElementById('analiseViabilidadeFII').innerHTML = analiseTexto;
            },

            analisarInflacao: () => {
                const taxaRetorno = parseFloat(sessionStorage.getItem('totalDividendoAnualPercentual'));
                const inflacaoAnual = parseFloat(document.getElementById('inflacaoAnual').value);
                const patrimonioTotal = parseFloat(sessionStorage.getItem('patrimonioTotal'));
                const valorFii = parseFloat(sessionStorage.getItem('valorFii'));
                const resultadoDiv = document.getElementById('resultadoInflacao');

                if (isNaN(taxaRetorno) || isNaN(inflacaoAnual) || isNaN(patrimonioTotal) || isNaN(valorFii)) {
                    resultadoDiv.classList.add('hidden');
                    return;
                }

                const retornoRealDecimal = ((taxaRetorno) - (inflacaoAnual));
                const retornoRealPercentual = retornoRealDecimal;
                const aporteFiiInflacao = valorFii * (inflacaoAnual / 100);
                sessionStorage.setItem('aporteFiiInflacao', aporteFiiInflacao);

                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                const retornoRealSpan = document.getElementById('retornoReal');
                const retornoRealExplicacaoP = document.getElementById('retornoRealExplicacao');
                const aporteFiiInflacaoSpan = document.getElementById('aporteFiiInflacao');
                const aporteFiiExplicacaoP = document.getElementById('aporteFiiExplicacao');
                
                retornoRealSpan.textContent = `${retornoRealPercentual.toFixed(2)}%`;
                retornoRealSpan.classList.toggle('text-green-900', retornoRealPercentual > 0);
                retornoRealSpan.classList.toggle('text-red-900', retornoRealPercentual <= 0);
                retornoRealExplicacaoP.textContent = `Seu poder de compra está ${retornoRealPercentual > 0 ? 'aumentando' : 'diminuindo'}.`;
                
                const fiiDividendoPercentual = parseFloat(document.getElementById('fiiDividendoPercentual').value);
               // const dividendoMensalFiiAtual = (valorFii * fiiDividendoPercentual / 100) / 12;
                const novoDividendoMensal = aporteFiiInflacao/12;
                
                aporteFiiInflacaoSpan.textContent = `${formatter.format(aporteFiiInflacao)} (${formatter.format(novoDividendoMensal)} mensais)`;
                aporteFiiExplicacaoP.textContent = `Aporte para manter o poder de compra.`;

                resultadoDiv.classList.remove('hidden');
                document.getElementById('reportRetornoReal').textContent = `${retornoRealPercentual.toFixed(2)}%`;
                document.getElementById('reportAporteFiiInflacao').textContent = formatter.format(aporteFiiInflacao);
            },

            calcularProximoAno: () => {
                const patrimonioTotal = parseFloat(sessionStorage.getItem('patrimonioTotal'));
                const totalDividendoAnual = parseFloat(sessionStorage.getItem('totalDividendoAnual'));
                const fiiDividendoAnual = parseFloat(sessionStorage.getItem('fiiDividendoAnual'));
                const aporteFiiInflacao = parseFloat(sessionStorage.getItem('aporteFiiInflacao'));
                const resultadoDiv = document.getElementById('resultadoProximoAno');

                if (isNaN(patrimonioTotal) || isNaN(totalDividendoAnual) || isNaN(fiiDividendoAnual) || isNaN(aporteFiiInflacao)) return;
                
                const crescimentoLiquido = totalDividendoAnual - aporteFiiInflacao;
                const novoPatrimonio = patrimonioTotal + crescimentoLiquido;
                const crescimentoPercentual = (crescimentoLiquido / patrimonioTotal) * 100;
                
                const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 });
                document.getElementById('patrimonioProximoAno').textContent = formatter.format(novoPatrimonio);
                document.getElementById('crescimentoValor').textContent = formatter.format(crescimentoLiquido);
                document.getElementById('crescimentoPercentual').textContent = `${crescimentoPercentual.toFixed(2)}%`;
                
                resultadoDiv.classList.remove('hidden');
            }
        };

        // Adiciona um único ouvinte de evento para toda a página
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('main-container').addEventListener('input', Calculadora.recalcularTudo);
            Calculadora.recalcularTudo();
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #d6eaff, #f0f4f9);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .scrollable-table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
    </style>
</body>
</html>
