<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Financeiro Expert (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        input:focus { ring: 2px; ring-color: #6366f1; outline: none; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="py-10 px-4 min-h-screen flex justify-center">

    <div class="card p-8 max-w-5xl w-full space-y-12" id="main-container">
        
        <div class="text-center space-y-2 border-b border-gray-100 pb-6">
            <div class="text-xs text-gray-400 text-right">ID: <span id="userIdDisplay">Local User</span></div>
            <h1 class="text-3xl font-bold text-slate-800">Planejamento de Independ√™ncia Financeira</h1>
            
            <p class="text-[10px] text-gray-400 font-medium tracking-wide">
                By Mosar Faria Botelho Dez/2025 - Toda informa√ß√£o do relat√≥rio n√£o √© recomenda√ß√£o apenas estudo introdut√≥rio de viabilidade
            </p>
            
            <p class="text-slate-600 pt-2">Simula√ß√£o Avan√ßada: Regra dos 4% & Prote√ß√£o Inflacion√°ria</p>
        </div>

        <div class="bg-indigo-50 p-6 rounded-xl border-l-4 border-indigo-600 shadow-sm">
            <h3 class="text-lg font-bold text-indigo-900 mb-2">üìö 1. Metodologia (Trinity Study)</h3>
            <p class="text-sm text-indigo-800 text-justify leading-relaxed" id="textoConceito">
                Este modelo utiliza a <strong>Regra dos 4%</strong> como base para definir o patrim√¥nio alvo. Ela sugere que retirar anualmente 4% do portf√≥lio inicial (ajustado pela infla√ß√£o) oferece alta probabilidade de sustentabilidade por 30 anos. Se o rendimento real da sua carteira superar essa taxa, o excedente fortalece a perpetuidade do capital.
            </p>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                <span class="bg-slate-800 text-white py-1 px-3 rounded-full text-sm mr-3">2</span> 
                Objetivos Financeiros
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Renda Mensal Desejada (R$)</label>
                    <input type="number" id="valorDesejado" value="12000" class="w-full p-3 rounded-lg border border-gray-300 transition font-bold text-slate-700">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Taxa de Retirada Segura (%)</label>
                    <input type="number" id="percentual" value="3.0" step="0.1" class="w-full p-3 rounded-lg border border-gray-300 transition">
                    <p class="text-xs text-gray-500 mt-1">Padr√£o Trinity: 4%. Perfil Conservador: 3%.</p>
                </div>
            </div>
            
            <div id="resultadoPatrimonio" class="mt-6 pt-6 border-t border-gray-100 text-center hidden">
                <p class="text-gray-500 font-medium uppercase text-xs tracking-wider">Patrim√¥nio Total Necess√°rio</p>
                <p id="valorPatrimonio" class="text-4xl font-extrabold text-slate-900 mt-2"></p>
            </div>
        </div>

        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                <span class="bg-slate-800 text-white py-1 px-3 rounded-full text-sm mr-3">3</span> 
                Estrutura de Capital
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="w-24"><label class="text-sm font-bold text-slate-700">FII (%)</label><input type="number" id="fiiPercentual" value="40" class="w-full p-2 border rounded mt-1 text-center font-semibold text-blue-600"></div>
                        <div class="flex-1 bg-gray-50 p-2 rounded flex justify-between items-center"><span class="text-sm text-gray-600">Alocado:</span><span id="fiiValor" class="font-bold text-slate-800">R$ 0,00</span></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-24"><label class="text-sm font-bold text-slate-700">A√ß√µes (%)</label><input type="number" id="acoesPercentual" value="30" class="w-full p-2 border rounded mt-1 text-center"></div>
                        <div class="flex-1 bg-gray-50 p-2 rounded flex justify-between items-center"><span class="text-sm text-gray-600">Alocado:</span><span id="acoesValor" class="font-bold text-slate-800">R$ 0,00</span></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-24"><label class="text-sm font-bold text-slate-700">R. Fixa (%)</label><input type="number" id="rendaFixaPercentual" value="20" class="w-full p-2 border rounded mt-1 text-center"></div>
                        <div class="flex-1 bg-gray-50 p-2 rounded flex justify-between items-center"><span class="text-sm text-gray-600">Alocado:</span><span id="rendaFixaValor" class="font-bold text-slate-800">R$ 0,00</span></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-24"><label class="text-sm font-bold text-slate-700">Exter. (%)</label><input type="number" id="internacionalPercentual" class="w-full p-2 border bg-gray-100 rounded mt-1 text-center font-bold text-gray-500" readonly></div>
                        <div class="flex-1 bg-gray-50 p-2 rounded flex justify-between items-center"><span class="text-sm text-gray-600">Alocado:</span><span id="internacionalValor" class="font-bold text-slate-800">R$ 0,00</span></div>
                    </div>
                </div>
                <div class="h-64 flex justify-center items-center bg-white border border-gray-100 rounded-lg p-2 shadow-sm" id="pieChartContainer">
                    <canvas id="portfolioPieChart"></canvas>
                </div>
            </div>
        </div>

        <hr class="border-gray-200">

        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                <span class="bg-slate-800 text-white py-1 px-3 rounded-full text-sm mr-3">4</span> 
                Proje√ß√£o de Dividendos (Yield on Cost)
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div><label class="text-xs font-bold text-gray-500 uppercase">FII Yield (%)</label><input type="number" id="fiiDividendoPercentual" value="10" class="w-full p-2 border rounded border-blue-200 font-semibold"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">A√ß√µes Yield (%)</label><input type="number" id="acoesDividendoPercentual" value="6" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">R. Fixa Yield (%)</label><input type="number" id="rendaFixaDividendoPercentual" value="12" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Exterior Yield (%)</label><input type="number" id="internacionalDividendoPercentual" value="2" class="w-full p-2 border rounded"></div>
            </div>
            
            <div id="resultadoDividendos" class="bg-emerald-50 p-6 rounded-lg border border-emerald-200 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <span class="block text-sm text-emerald-800 mb-1">Renda Passiva Anual Estimada</span>
                        <span id="totalDividendoAnual" class="font-bold text-emerald-900 text-2xl"></span>
                    </div>
                    <div>
                        <span class="block text-sm text-emerald-800 mb-1 font-bold">Renda Mensal M√©dia</span>
                        <span id="totalDividendoMensal" class="font-extrabold text-emerald-900 text-3xl"></span>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-emerald-200 text-xs text-emerald-800 flex justify-between flex-wrap gap-2">
                    <span class="font-bold">Contribui√ß√£o na Renda:</span>
                    <span id="fiiShare"></span> | <span id="acoesShare"></span> | <span id="rendaFixaShare"></span> | <span id="internacionalShare"></span>
                </div>
            </div>
        </div>

        <hr class="border-gray-200">

        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                <span class="bg-slate-800 text-white py-1 px-3 rounded-full text-sm mr-3">5</span> 
                Plano de Acumula√ß√£o
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label class="text-sm font-semibold text-slate-700">Patrim√¥nio Atual (R$)</label><input type="number" id="aporteInicial" value="100000" class="w-full p-2 rounded border"></div>
                <div><label class="text-sm font-semibold text-slate-700">Yield Ponderado (% a.a)</label><input type="number" id="taxaRetorno" class="w-full p-2 rounded border bg-gray-100 font-bold text-slate-600" readonly></div>
                <div><label class="text-sm font-semibold text-slate-700">Anos para Meta</label><input type="number" id="anos" value="10" class="w-full p-2 rounded border"></div>
            </div>

            <div id="resultadoInvestimento" class="mt-6 text-center hidden mb-6 bg-indigo-50 p-4 rounded-lg">
                <p class="text-slate-600 text-sm">Aporte mensal necess√°rio para atingir a meta em <span id="anosDisplay"></span> anos:</p>
                <p id="valorInvestimento" class="text-3xl font-extrabold text-indigo-600 mt-1"></p>
            </div>
            
            <div class="w-full h-[400px] mt-8 hidden" id="chartContainer">
                <canvas id="investmentChart"></canvas>
            </div>
        </div>

        <hr class="border-gray-200">

        <div class="bg-amber-50 p-6 rounded-xl border border-amber-200 shadow-sm">
            <h2 class="text-xl font-bold text-amber-900 mb-4 flex items-center">
                <span class="bg-amber-600 text-white py-1 px-3 rounded-full text-sm mr-3">6</span> 
                Prote√ß√£o Inflacion√°ria (FIIs)
            </h2>
            
            <div class="flex items-center gap-4 mb-4">
                <label class="text-sm font-bold text-amber-900">IPCA Projetado (% a.a):</label>
                <input type="number" id="inflacaoAnual" value="4.5" class="w-24 p-2 rounded border border-amber-400 bg-white text-center">
            </div>

            <div class="mb-6 p-4 bg-amber-100 rounded-lg border-l-4 border-amber-500 text-sm text-amber-900 italic leading-relaxed">
                <p id="textoExplicacaoInflacao">
                    <strong>Conceito Fundamental:</strong> Assumimos que as A√ß√µes e Investimentos Internacionais possuem prote√ß√£o natural contra infla√ß√£o via valoriza√ß√£o da cota. J√° os FIIs (que distribuem a maior parte do lucro em dinheiro) exigem este reinvestimento manual para n√£o perderem poder de compra.
                </p>
            </div>
            
            <div id="resultadoInflacao" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center hidden">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <p class="text-xs text-gray-500 uppercase font-bold">Crescimento Real (Global)</p>
                    <p id="retornoReal" class="text-xl font-bold mt-1"></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-amber-400">
                    <p class="text-xs text-gray-500 uppercase font-bold">Reinvestimento Anual (FIIs)</p>
                    <p id="aporteFiiInflacao" class="text-xl font-bold text-amber-900 mt-1"></p>
                    <p class="text-[10px] text-gray-400 mt-1">Corre√ß√£o do Principal</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-b-4 border-amber-400">
                    <p class="text-xs text-gray-500 uppercase font-bold">Dedu√ß√£o Mensal</p>
                    <p id="aporteMensalInflacao" class="text-xl font-bold text-amber-900 mt-1"></p>
                    <p class="text-[10px] text-gray-400 mt-1">Retirar do fluxo de caixa</p>
                </div>
            </div>
        </div>

        <div class="bg-slate-900 text-white p-8 rounded-xl shadow-lg mt-8">
            <h2 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2">7. Conclus√£o & Viabilidade</h2>
            <div id="analiseViabilidadeCompleta" class="space-y-6 text-sm leading-relaxed text-gray-300">
                Aguardando processamento...
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-center gap-4 pt-4 pb-0">
            <button onclick="saveLocalData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v5h-2V4z" />
                </svg>
                Salvar Dados
            </button>
            <button id="btnExportarPDF" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow transition flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Baixar Relat√≥rio (PDF)
            </button>
        </div>
        
        <div id="saveMessage" class="text-center mt-2 h-6 hidden fade-in">
            <span class="text-green-600 font-bold bg-green-100 px-4 py-1 rounded-full text-sm border border-green-200 shadow-sm">
                ‚úÖ Dados Salvos Localmente!
            </span>
        </div>

    </div>

    <script>
        // --- GERENCIAMENTO DE DADOS LOCAIS (LocalStorage) ---
        function saveLocalData() {
            const inputs = document.querySelectorAll('input');
            const data = {};
            inputs.forEach(input => {
                data[input.id] = input.value;
            });
            localStorage.setItem('userFinancialData', JSON.stringify(data));
            
            // Feedback Visual ABAIXO do Bot√£o
            const msgDiv = document.getElementById('saveMessage');
            msgDiv.classList.remove('hidden');
            
            // Remove ap√≥s 5 segundos
            setTimeout(() => {
                msgDiv.classList.add('hidden');
            }, 5000);
        }

        function loadLocalData() {
            const saved = localStorage.getItem('userFinancialData');
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key];
                });
                return true;
            }
            return false;
        }

        // --- L√ìGICA DA CALCULADORA ---
        let chartGrowth = null;
        let chartAlloc = null;

        const Calculadora = {
            recalcularTudo: () => {
                Calculadora.calcPatrimonio();
                Calculadora.calcCarteira();
                Calculadora.calcDividendos();
                Calculadora.calcInvestimento();
                Calculadora.calcInflacao();
                Calculadora.gerarAnalise();
            },

            calcPatrimonio: () => {
                const desejado = parseFloat(document.getElementById('valorDesejado').value) || 0;
                const pct = parseFloat(document.getElementById('percentual').value) || 0;
                if(pct <= 0) return;
                const total = (desejado * 12) / (pct / 100);
                sessionStorage.setItem('patrimonioTotal', total);
                
                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('valorPatrimonio').textContent = fmt.format(total);
                document.getElementById('resultadoPatrimonio').classList.remove('hidden');
            },

            calcCarteira: () => {
                const total = parseFloat(sessionStorage.getItem('patrimonioTotal')) || 0;
                const fiiP = parseFloat(document.getElementById('fiiPercentual').value) || 0;
                const acoesP = parseFloat(document.getElementById('acoesPercentual').value) || 0;
                const rendaP = parseFloat(document.getElementById('rendaFixaPercentual').value) || 0;
                const interP = Math.max(0, 100 - (fiiP + acoesP + rendaP));
                document.getElementById('internacionalPercentual').value = interP.toFixed(2);

                const vals = { fii: total*(fiiP/100), acoes: total*(acoesP/100), renda: total*(rendaP/100), inter: total*(interP/100) };
                sessionStorage.setItem('carteiraValores', JSON.stringify(vals));

                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('fiiValor').textContent = fmt.format(vals.fii);
                document.getElementById('acoesValor').textContent = fmt.format(vals.acoes);
                document.getElementById('rendaFixaValor').textContent = fmt.format(vals.renda);
                document.getElementById('internacionalValor').textContent = fmt.format(vals.inter);

                Calculadora.renderPizza([fiiP, acoesP, rendaP, interP]);
            },

            renderPizza: (data) => {
                const ctx = document.getElementById('portfolioPieChart');
                if(!ctx) return;
                if(chartAlloc) chartAlloc.destroy();
                chartAlloc = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['FII', 'A√ß√µes', 'R. Fixa', 'Internacional'],
                        datasets: [{ data: data, backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#64748b'], borderWidth: 1 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right' } } }
                });
            },

            calcDividendos: () => {
                const total = parseFloat(sessionStorage.getItem('patrimonioTotal')) || 0;
                const ps = {
                    fii: parseFloat(document.getElementById('fiiPercentual').value)/100,
                    acoes: parseFloat(document.getElementById('acoesPercentual').value)/100,
                    renda: parseFloat(document.getElementById('rendaFixaPercentual').value)/100,
                    inter: parseFloat(document.getElementById('internacionalPercentual').value)/100
                };
                const ys = {
                    fii: parseFloat(document.getElementById('fiiDividendoPercentual').value)/100,
                    acoes: parseFloat(document.getElementById('acoesDividendoPercentual').value)/100,
                    renda: parseFloat(document.getElementById('rendaFixaDividendoPercentual').value)/100,
                    inter: parseFloat(document.getElementById('internacionalDividendoPercentual').value)/100
                };

                const divs = {
                    fii: (total * ps.fii) * ys.fii,
                    acoes: (total * ps.acoes) * ys.acoes,
                    renda: (total * ps.renda) * ys.renda,
                    inter: (total * ps.inter) * ys.inter
                };

                const totalAnual = Object.values(divs).reduce((a,b) => a+b, 0);
                const totalMensal = totalAnual / 12;
                
                // Saving Details for PDF
                const detalheDividendos = {
                    fii: { val: divs.fii, share: totalAnual ? (divs.fii/totalAnual)*100 : 0, yield: ys.fii*100 },
                    acoes: { val: divs.acoes, share: totalAnual ? (divs.acoes/totalAnual)*100 : 0, yield: ys.acoes*100 },
                    renda: { val: divs.renda, share: totalAnual ? (divs.renda/totalAnual)*100 : 0, yield: ys.renda*100 },
                    inter: { val: divs.inter, share: totalAnual ? (divs.inter/totalAnual)*100 : 0, yield: ys.inter*100 }
                };
                sessionStorage.setItem('detalheDividendos', JSON.stringify(detalheDividendos));
                sessionStorage.setItem('totalDividendoAnual', totalAnual);
                sessionStorage.setItem('divFiiAnual', divs.fii); 

                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('totalDividendoAnual').textContent = fmt.format(totalAnual);
                document.getElementById('totalDividendoMensal').textContent = fmt.format(totalMensal);
                document.getElementById('resultadoDividendos').classList.remove('hidden');

                const totalShare = totalAnual || 1;
                document.getElementById('fiiShare').textContent = `FII: ${((divs.fii/totalShare)*100).toFixed(0)}%`;
                document.getElementById('acoesShare').textContent = `A√ß√µes: ${((divs.acoes/totalShare)*100).toFixed(0)}%`;
                document.getElementById('rendaFixaShare').textContent = `RF: ${((divs.renda/totalShare)*100).toFixed(0)}%`;
                document.getElementById('internacionalShare').textContent = `Ext: ${((divs.inter/totalShare)*100).toFixed(0)}%`;

                const yieldPonderado = (totalAnual / total) * 100;
                document.getElementById('taxaRetorno').value = yieldPonderado.toFixed(2);
            },

            calcInvestimento: () => {
                const aporteIni = parseFloat(document.getElementById('aporteInicial').value) || 0;
                const taxa = parseFloat(document.getElementById('taxaRetorno').value) || 0;
                const anos = parseFloat(document.getElementById('anos').value) || 0;
                const meta = parseFloat(sessionStorage.getItem('patrimonioTotal')) || 0;

                document.getElementById('anosDisplay').textContent = anos;
                if(anos <= 0) return;

                const i = (taxa / 100) / 12;
                const n = anos * 12;
                let pmt = 0;
                const fv_pv = meta - (aporteIni * Math.pow(1+i, n));
                if (fv_pv > 0) pmt = fv_pv * i / (Math.pow(1+i, n) - 1);

                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('valorInvestimento').textContent = fmt.format(pmt);
                document.getElementById('resultadoInvestimento').classList.remove('hidden');
                
                Calculadora.renderEvolution(aporteIni, pmt, i, n, anos);
            },

            renderEvolution: (pv, pmt, iMonthly, months, years) => {
                const labels = []; const patData = []; const rendaData = []; let currentPat = pv;
                for(let y=0; y<=years; y++) {
                    labels.push(`Ano ${y}`);
                    patData.push(currentPat);
                    rendaData.push(currentPat * iMonthly);
                    for(let m=0; m<12; m++) currentPat = (currentPat + pmt) * (1 + iMonthly);
                }
                document.getElementById('chartContainer').classList.remove('hidden');
                const ctx = document.getElementById('investmentChart');
                if(!ctx) return;
                if(chartGrowth) chartGrowth.destroy();
                chartGrowth = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Patrim√¥nio (R$)', data: patData, type: 'line', borderColor: '#4f46e5', backgroundColor: '#4f46e5', borderWidth: 3, pointRadius: 2, yAxisID: 'y' },
                            { label: 'Renda Mensal (R$)', data: rendaData, type: 'bar', backgroundColor: '#10b981', yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: { display: true, position: 'left', title: {display:true, text:'Patrim√¥nio'} },
                            y1: { display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'Renda Mensal'} }
                        }
                    }
                });
            },

            calcInflacao: () => {
                const taxaNominal = parseFloat(document.getElementById('taxaRetorno').value) || 0;
                const inf = parseFloat(document.getElementById('inflacaoAnual').value) || 0;
                const real = ((1 + taxaNominal/100) / (1 + inf/100) - 1) * 100;
                
                const carteira = JSON.parse(sessionStorage.getItem('carteiraValores'));
                const valorFii = carteira ? carteira.fii : 0;
                const aporteInfAnual = valorFii * (inf/100);
                const aporteInfMensal = aporteInfAnual / 12;

                const elReal = document.getElementById('retornoReal');
                elReal.textContent = `${real.toFixed(2)}% a.a.`;
                elReal.className = real > 0 ? "text-xl font-bold mt-1 text-green-600" : "text-xl font-bold mt-1 text-red-600";

                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('aporteFiiInflacao').textContent = fmt.format(aporteInfAnual);
                document.getElementById('aporteMensalInflacao').textContent = fmt.format(aporteInfMensal);
                document.getElementById('resultadoInflacao').classList.remove('hidden');
            },

            gerarAnalise: () => {
                const rendaFiiAnual = parseFloat(sessionStorage.getItem('divFiiAnual')) || 0;
                const rendaFiiMensal = rendaFiiAnual / 12;
                const meta = parseFloat(document.getElementById('valorDesejado').value) || 0;
                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                const regraPct = parseFloat(document.getElementById('percentual').value);
                const yieldTotal = parseFloat(document.getElementById('taxaRetorno').value);
                const spread = yieldTotal - regraPct;
                const totalPatrimonio = parseFloat(sessionStorage.getItem('patrimonioTotal')) || 0;

                const valRegra = (totalPatrimonio * (regraPct/100)) / 12;
                const valYield = (totalPatrimonio * (yieldTotal/100)) / 12;

                let html = ""; let txtPdf = "";

                // 1. Cen√°rio S√≥ FIIs
                html += `<div class="mb-4 pb-4 border-b border-gray-700"><h3 class="text-white font-bold mb-2">A. Cen√°rio Conservador: Viver Apenas de FIIs</h3>`;
                const cobFii = (rendaFiiMensal / meta) * 100;
                if(cobFii >= 100) {
                    html += `<p class="text-emerald-400">‚úÖ <strong>Suficiente:</strong> FIIs geram ${fmt.format(rendaFiiMensal)} e cobrem a meta.</p>`;
                    txtPdf += `CEN√ÅRIO A (S√≥ FIIs): A renda gerada exclusivamente pelos FIIs √© de ${fmt.format(rendaFiiMensal)}, cobrindo 100% da sua meta mensal. `;
                } else {
                    html += `<p class="text-amber-400">‚ö†Ô∏è <strong>Depend√™ncia Mista:</strong> FIIs cobrem ${cobFii.toFixed(1)}%.</p>`;
                    txtPdf += `CEN√ÅRIO A (S√≥ FIIs): A renda de FIIs (${fmt.format(rendaFiiMensal)}) cobre ${cobFii.toFixed(1)}% da meta. Necess√°rio complemento com outros ativos. `;
                }
                html += `</div>`;

                // 2. Conclus√£o Regra 4%
                html += `<div><h3 class="text-white font-bold mb-2">B. Comparativo de Rentabilidade</h3>`;
                const strRegra = `${regraPct}% (${fmt.format(valRegra)}/m√™s)`;
                const strYield = `${yieldTotal.toFixed(2)}% (${fmt.format(valYield)}/m√™s)`;

                if (spread > 0) {
                    html += `<p class="text-gray-300">Seu Yield de <strong>${strYield}</strong> supera a taxa de retirada segura de <strong>${strRegra}</strong>. <br>Isso indica robustez.</p>`;
                    txtPdf += `CEN√ÅRIO B (Rentabilidade): O Yield da carteira de ${strYield} supera a regra de retirada segura de ${strRegra}. O excedente financeiro deve ser reinvestido.`;
                } else {
                    html += `<p class="text-red-300">Aten√ß√£o: Seu Yield de <strong>${strYield}</strong> est√° abaixo da regra de <strong>${strRegra}</strong>.</p>`;
                    txtPdf += `CEN√ÅRIO B (Rentabilidade): Alerta. O Yield atual de ${strYield} √© inferior √† taxa de retirada segura de ${strRegra}, indicando potencial consumo do principal.`;
                }
                html += `</div>`;

                document.getElementById('analiseViabilidadeCompleta').innerHTML = html;
                sessionStorage.setItem('analisePdfFinal', txtPdf);
            }
        };

        const gerarPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a4', unit: 'mm' });
            const margem = 20; let y = margem; const width = 170;
            const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            
            const addTitle = (t) => { doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(30,60,114); doc.text(t, margem, y); y+=6; };
            const addPara = (t) => { doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(0,0,0); const l = doc.splitTextToSize(t, width); if(y+l.length*5>280){doc.addPage();y=margem;} doc.text(l, margem, y); y+=(l.length*5)+4; };

            // CAPA
            doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.setTextColor(30,60,114);
            doc.text("RELAT√ìRIO DE VIABILIDADE FINANCEIRA", 105, y, {align:'center'}); y+=7;
            
            // DISCLAIMER CAPA
            doc.setFont('helvetica', 'italic'); doc.setFontSize(8); doc.setTextColor(120);
            doc.text("By Mosar Faria Botelho Dez/2025 - Toda informa√ß√£o do relat√≥rio n√£o √© recomenda√ß√£o apenas estudo introdut√≥rio de viabilidade", 105, y, {align:'center'}); y+=10;

            doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(100);
            doc.text("Gerado em " + new Date().toLocaleDateString(), 105, y, {align:'center'}); y+=15;

            // 1. CONCEITO
            addTitle("1. METODOLOGIA E CONCEITOS");
            addPara(document.getElementById('textoConceito').textContent.replace(/\s+/g,' ').trim());

            // 2. OBJETIVOS
            addTitle("2. OBJETIVOS E METAS FINANCEIRAS");
            const rMensal = parseFloat(document.getElementById('valorDesejado').value);
            const perc = document.getElementById('percentual').value;
            const patTotal = document.getElementById('valorPatrimonio').textContent;
            
            const textoObj = `Considerando a meta da renda mensal de ${fmt.format(rMensal)} para corresponder a ${perc}% do total do Patrim√¥nio, conseguimos estimar a Meta Salarial Mensal de ${fmt.format(rMensal)} que corresponder√° a uma Meta Patrimonial de ${patTotal}.`;
            addPara(textoObj);

            // 3. ESTRUTURA (LAYOUT DUAS COLUNAS)
            addTitle("3. ESTRUTURA DE CAPITAL");
            const pFii = document.getElementById('fiiPercentual').value;
            const pAcao = document.getElementById('acoesPercentual').value;
            const textoAloc = `Para atingir este montante, a estrat√©gia de aloca√ß√£o de ativos distribui o capital com ${pFii}% em Fundos Imobili√°rios, ${pAcao}% em A√ß√µes e o restante balanceado em Renda Fixa e Investimentos Internacionais. Abaixo, a distribui√ß√£o visual e num√©rica:`;
            addPara(textoAloc);

            const chartSize = 65;
            if(y + chartSize > 270) { doc.addPage(); y = margem; }

            const cvsPie = document.getElementById('portfolioPieChart');
            if(cvsPie) { 
                const img = cvsPie.toDataURL('image/png'); 
                doc.addImage(img, 'PNG', margem, y, chartSize, chartSize); 
            }
            
            const xText = margem + chartSize + 10;
            let yText = y + 15;
            const cart = JSON.parse(sessionStorage.getItem('carteiraValores'));
            
            doc.setFontSize(10); doc.setTextColor(50);

            const linhaAloc = (label, val, pct) => {
                doc.setFont('helvetica', 'bold');
                doc.text(`‚Ä¢ ${label}:`, xText, yText);
                doc.setFont('helvetica', 'normal');
                doc.text(`${fmt.format(val)} (${pct}%)`, xText, yText + 5);
                yText += 12;
            };

            linhaAloc("Fundos Imobili√°rios", cart.fii, document.getElementById('fiiPercentual').value);
            linhaAloc("A√ß√µes Nacionais", cart.acoes, document.getElementById('acoesPercentual').value);
            linhaAloc("Renda Fixa", cart.renda, document.getElementById('rendaFixaPercentual').value);
            linhaAloc("Invest. Internacional", cart.inter, document.getElementById('internacionalPercentual').value);

            y += chartSize + 10;

            // 4. DIVIDENDOS DETALHADOS
            addTitle("4. PROJE√á√ÉO DETALHADA DE DIVIDENDOS");
            const divAnual = document.getElementById('totalDividendoAnual').textContent;
            addPara(`Com base nos Yields estimados, a carteira projeta um fluxo total anual de ${divAnual}. Abaixo, o detalhamento da contribui√ß√£o de cada classe de ativo para a sua renda:`);
            
            const detDiv = JSON.parse(sessionStorage.getItem('detalheDividendos'));
            doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(0,0,0);
            
            const linhaDiv = (label, obj) => {
                doc.text(`‚Ä¢ ${label} (Yield ${obj.yield.toFixed(1)}%): ${fmt.format(obj.val)}/ano (${obj.share.toFixed(1)}% da renda total)`, margem+5, y);
                y+=6;
            };
            
            linhaDiv("Fundos Imobili√°rios", detDiv.fii);
            linhaDiv("A√ß√µes", detDiv.acoes);
            linhaDiv("Renda Fixa", detDiv.renda);
            linhaDiv("Exterior", detDiv.inter);
            y+=5;
            
            addPara(`‚Ä¢ Renda Mensal M√©dia Projetada (Total): ${document.getElementById('totalDividendoMensal').textContent}`);

            // 5. ACUMULA√á√ÉO
            if(y > 220) { doc.addPage(); y=margem; }
            addTitle("5. PLANO DE ACUMULA√á√ÉO");
            const aporteIni = parseFloat(document.getElementById('aporteInicial').value);
            const prazo = document.getElementById('anosDisplay').textContent;
            const aporteMes = document.getElementById('valorInvestimento').textContent;

            const textoAcum = `Partindo de um capital inicial de ${fmt.format(aporteIni)} e considerando um prazo de acumula√ß√£o de ${prazo} anos, o c√°lculo atuarial indica a necessidade do seguinte esfor√ßo de poupan√ßa mensal:`;
            addPara(textoAcum);
            doc.setFont('helvetica','bold');
            doc.text(`Aporte Mensal Necess√°rio: ${aporteMes}`, margem, y); y+=10;
            doc.setFont('helvetica','normal');
            
            const cvsBar = document.getElementById('investmentChart');
            if(cvsBar) {
                const ctx = cvsBar.getContext('2d');
                ctx.save(); ctx.globalCompositeOperation='destination-over'; ctx.fillStyle='white'; ctx.fillRect(0,0,cvsBar.width, cvsBar.height); ctx.restore();
                doc.addImage(cvsBar.toDataURL('image/png'), 'PNG', margem, y, width, 80); y+=85;
            }

            // 6. INFLA√á√ÉO
            if(y > 220) { doc.addPage(); y=margem; }
            addTitle("6. AN√ÅLISE INFLACION√ÅRIA (FIIs)");
            const txtInf = document.getElementById('textoExplicacaoInflacao').innerText.replace(/\s+/g, ' ').trim();
            addPara(txtInf);
            
            const infVal = document.getElementById('aporteFiiInflacao').textContent;
            const infMes = document.getElementById('aporteMensalInflacao').textContent;
            
            addPara(`Para blindar o patrim√¥nio imobili√°rio contra a perda de poder de compra, sugere-se o seguinte reinvestimento mandat√≥rio:`);
            doc.setFont('helvetica','bold');
            doc.text(`‚Ä¢ Reinvestimento Anual Sugerido: ${infVal}`, margem, y); y+=6;
            doc.text(`‚Ä¢ Reinvestimento Mensal Sugerido: ${infMes}`, margem, y); y+=10;

            // 7. CONCLUS√ÉO
            addTitle("7. CONCLUS√ÉO E VIABILIDADE");
            addPara(sessionStorage.getItem('analisePdfFinal'));

            doc.save("Relatorio_Financeiro_Completo.pdf");
        };

        // INICIALIZA√á√ÉO E CARREGAMENTO
        document.addEventListener('DOMContentLoaded', () => {
            const hasData = loadLocalData();
            
            document.getElementById('main-container').addEventListener('input', Calculadora.recalcularTudo);
            const btn = document.getElementById('btnExportarPDF');
            if(btn) btn.addEventListener('click', gerarPDF);
            
            setTimeout(() => {
                Calculadora.recalcularTudo();
                if(hasData) {
                    const status = document.getElementById('userIdDisplay');
                    status.textContent = "Dados Restaurados";
                    status.className = "text-green-500 font-bold";
                    setTimeout(() => {
                        status.textContent = "Local User";
                        status.className = "text-xs text-gray-400 text-right";
                    }, 3000);
                }
            }, 500);
        });
    </script>
</body>
</html>
